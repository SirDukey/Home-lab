---
- name: NFS | Ensure NFS export directory exists
  ansible.builtin.file:
    path: /media
    state: directory
    mode: '0755'
  tags: nfs

- name: NFS | Ensure export line is present in /etc/exports
  ansible.builtin.lineinfile:
    path: /etc/exports
    line: "/media {{ nfs__allowed_clients | default('*') }}(rw,sync,no_subtree_check,no_root_squash)"
    create: true
    mode: '0644'
    state: present
    regexp: "^/media\\s"
  notify: Reload NFS exports
  tags: nfs

- name: NFS | Ensure NFS service is enabled and started
  ansible.builtin.service:
    name: "{{ 'nfs-kernel-server' if ansible_os_family == 'Debian' else 'nfs-server' }}"
    enabled: true
    state: started
  become: true
  tags: nfs
